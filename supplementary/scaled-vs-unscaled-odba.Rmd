---
title: "Comparing scaled and unscaled ODBA values"
output: 
  rmdformats::robobook:
    code_folding: hide
    toc_depth: 2
---

# Background

*Purpose*: This notebook is used to compare scaled and unscaled ODBA values and create a figure that is included in the supplementary materials for the manuscript.

*Inputs*: The following input datasets are required:

* Scaling factors (supplementary/supp-data/scaling_factors)
* Scaled and unscaled ODBA datasets (supplementary/supp-data/scaled-and-unscaled-odba.data.csv) 

*Outputs*: A figure for the manuscript in saved in "supplementary/supp-outputs/"

Accelerometer accuracy can critically influence trends in accelerometer data (Garde et al., 2022). We used the 6-orientation ("6O") calibration method described by Garde et al. (2022) to assess accelerometer accuracy before data loggers were deployed. 

Briefly, each data logger was held stationary in six different orientations, and a scaling or correction factor for each axis was determined by comparing raw accelerometry values with expected values. An R Markdown showing exactly how these values were calculated (*scaling_nano_6O-method.html*) is included in a supplementary folder ("supplementary/supp-preprocessing/").

We were unable to apply a correction factor to data processed on board the device, so to test whether tag accuracy influenced inter-individual differences in mean ODBA, we compared corrected and uncorrected mean ODBA values based on the raw accelerometry data.

```{r Setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(digits=3, digit.secs=2, scipen=10)
```

```{r Prepare workspace, message=FALSE, results=FALSE}
library(here)
library(dplyr)
library(tidyr)
library(flextable)
library(ggplot2)
library(extrafont)
library(extrafont)

set_flextable_defaults(
  font.size = 11,
  theme_fun = theme_booktabs,
  font.family = "Calibri",
  padding = 3,
  background.color = "white")

output_path = "./supplementary/supp-outputs/"
```

```{r Import scaling factors}
scaling_factors <- read.csv(here("supplementary","supp-data","tag_6O_scaling_factors.csv"))

scaling_factors %>% flextable()
```

```{r Summarise scaling factors}
scaling_factors %>%
  pivot_longer(!tag_ID,
               names_to = "axis",
               values_to="scaling_factor") %>%
  summarise(min_factor = min(scaling_factor),
            max_factor = max(scaling_factor),
            mean_factor = mean(scaling_factor),
            sd_factor = sd(scaling_factor)) %>%
  flextable()
```

In a separate script, these scaling factors were applied to each axis of the raw accelerometry data (i.e. raw_x * x_scaling_factor) before calculating mean ODBA at 10 minute intervals. We also repeated the same calculations but without applying the scaling factors. The resulting dataset is "scaled-and-unscaled-odba.data.csv".

*Note* The raw accelerometry data files are very large and only peripheral to this manuscript, so are not included with the data accompanying the manuscript. However, these are available upon request.

Below, we look at the correlation between scaled and unscaled ODBA values among individuals. This allows us to determine whether differences in ODBA due to scaling are likely to have influenced our results. 

```{r Import scaled and unscaled odba data}
odba <- read.csv(here("supplementary","supp-data","scaled-and-unscaled-odba-data.csv"))
```

```{r Summarise mean values for each individual}
ind_odba <- odba %>%
  group_by(tag_ID) %>%
  summarise(mean_unscaled_odba=mean(mean_unscaled_ODBA, na.rm=T),
            mean_scaled_odba=mean(mean_scaled_ODBA, na.rm=T),
            n_windows=n()) %>%
  filter(!is.na(mean_scaled_odba))

ind_odba %>%
  arrange(mean_unscaled_odba) %>%
  flextable()
```

```{r Specify plot format}
legend.heading.size = 10
axis.heading.size = 10
label.size = 10
small.point.size = 1
```

```{r Calculate correlation and plot}
scaling_cor = cor.test(ind_odba$mean_scaled_odba, ind_odba$mean_unscaled_odba, method="spearman")

scaling_cor_plot <- ggplot(ind_odba, aes(x=mean_scaled_odba, y=mean_unscaled_odba)) +
  geom_point(size=small.point.size)+
  theme_classic()+
  xlab("\ncalibrated mean ODBA") +
  ylab("mean ODBA without calibration\n") +
  geom_text(x = 0.04, y=0.55,
            hjust=0,
            label=expression(r["s"]*" = 0.9998"),
            size=(axis.heading.size+1) / (14/5))+
  theme(axis.text = element_text(size=label.size),
        axis.title = element_text(size=axis.heading.size),
        plot.title = element_text(size=axis.heading.size+2))

scaling_cor_plot
```

```{r Save plot}
ggsave(plot=scaling_cor_plot,
       filename='figure-scaling-correlation.jpg',
       path=output_path,
       width=16,
       height=10,
       units="cm",
       dpi=300)

getwd()
```

The use of uncorrected ODBA values should have little to no effect on our results.