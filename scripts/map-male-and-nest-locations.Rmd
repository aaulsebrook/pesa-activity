---
title: 'Map male and nest locations'
author: Anne Aulsebrook
output: 
 # word_document
  rmdformats::robobook:
    code_folding: hide
    toc_depth: 2
---

```{r Set up workspace}
library(sf) # for spatial data
library(basemaps) # for mapping
library(wadeR)
library(dplyr)
library(dbo) # to access the database
library(lubridate) # for time functions
library(flextable) # for creating tables
library(stringr) # replace strings
library(tidyr)
library(ggplot2)
library(ggspatial) # for scale bar
library(ggsci) # nice for colour palettes

db_name = "FIELD_2022_CHARADRIIatBARROW"
user_name = "aaulsebrook"
path_outputs = "../outputs/"
plot_nests = TRUE

source("./general-helper-functions.R")

male_colour = "darkgreen"
female_colour = "gray32" 
```

```{r Prepare map elements and defaults}
set_defaults(map_service = "carto", map_type = "world_imagery")
CRSbasemap <- 3857
CRSdefault <- 4326
basemap <- map_empty()

map_crs <- options("wadeR.proj")[[1]]
```

# Prepare data

## Captures and sightings

```{r Import capture data, message=FALSE, results=FALSE}
con <- dbcon(db = 'FIELD_2022_CHARADRIIatBARROW')

captures <- dbq(con,
                "SELECT * FROM CAPTURES") %>%
  filter(species=="PESA") %>%
  mutate(date=local_date_to_posix(as.character(date)),
         colour_combo=case_when(is.na(LL) ~ LR,
                                TRUE ~ LL),
         tag_ID=tolower(tag_id),
         released_dt = local_dt_to_posix(paste(date,released))) %>%
  rename(bird_ID=ID)

tagged_males <- captures %>%
  filter(tag_action=="on") %>% 
  filter(!colour_combo %in% colour_combos_to_exclude) %>%
  select(colour_combo,bird_ID,tag_ID,date,released,released_dt, weight, wing, total_head)

sightings <- dbq(con,
                 "SELECT * FROM RESIGHTINGS") %>%
  filter(species=="PESA") %>%
  mutate(colour_combo=case_when(is.na(LL) ~ LR,
                                TRUE ~ LL))

gps_points <- dbq(con,
           "SELECT * FROM GPS_POINTS")

closeCon(con)
```

## Clutch initiation and female fertility

```{r Extract nest information, message=FALSE, results=FALSE}
con <- dbcon(
  user=user_name, 
  db = db_name)

nest_checks <- dbq(con, "SELECT * FROM NESTS") %>%
  filter(species=="PESA",
         nest!="P1801" & nest!="P1803") %>% # this excludes nests outside of study plot
  mutate(date=local_date_to_posix(as.character(date)),
         female_cc=case_when(is.na(f_LL) & is.na(f_LR) ~ NA,
                        is.na(f_LL) ~ f_LR,
                        is.na(f_LR) ~ f_LL))
  
nests <- nest_checks %>%
  arrange(date) %>%
  group_by(nest) %>%
  summarise(first_clutchsize=first(clutch_size), # use first in case predated
            max_clutchsize=max(clutch_size, na.rm=T),
            date_found=min(date))

eggs <- dbq(con,"SELECT * FROM EGGS_CHICKS_incubator") %>%
  filter(substr(nest, 1, 1)=="P") %>% # only include pectoral sandpipers
  mutate(est_hatch_date=local_date_to_posix(as.character(est_hatch_date)),
         hatch_date=local_date_to_posix(as.character(hatching_datetime)))

hatch_dates <- eggs %>%
  filter(!is.na(est_hatch_date)) %>% # exclude damaged eggs
  group_by(nest) %>%
  summarise(est_hatch_date=min(est_hatch_date),
            hatch_date=min(hatch_date))

nests <- full_join(nests,
                   hatch_dates,
                   by='nest')

closeCon(con)
```

```{r Determine clutch initiation date and fertile period}
nests$found_status <- if_else(
  nests$first_clutchsize==nests$max_clutchsize, 
  "complete",
  "laying"
)

nests <- nests %>%
  mutate(clutch_init = case_when(found_status=="laying" ~ date_found-first_clutchsize*86400,
                                 is.na(hatch_date) ~ est_hatch_date - 22*86400 - (max_clutchsize-1)*86400,
                                 TRUE ~ hatch_date - 22*86400 - (max_clutchsize-1)*86400),
         penult_egg = case_when(max_clutchsize>1 ~ clutch_init + (max_clutchsize-2)*86400,
                                TRUE ~ clutch_init),
         first_fertile_day=clutch_init-5*86400,
         last_fertile_day=penult_egg)
```

```{r Determine fertile period}
start_FertilePeriod <- round_date(
  quantile(nests$first_fertile_day, 0.05, na.rm=T),
  unit="day")
end_FertilePeriod <- round_date(
  quantile(nests$last_fertile_day, 0.95, na.rm=T),
  unit="day")
```

## Male locations

```{r Import gps data and sightings}
con <- dbcon(
  user=user_name, 
  db = db_name)

gps_tag <- dbq(con,
                "SELECT * FROM GPS_TAG") %>%
  filter(lat!=200 & lon!=200) %>% # these are readings when no GPS signal available
  mutate(datetime_cet=odba_to_posix(as.character(datetime_)),
         datetime_local=dt_to_local(datetime_cet),
         tagID=tolower(substr(tagID, 7,10))) %>%
  rename(tag_ID=tagID)

closeCon(con)

male_locations <- left_join(gps_tag, tagged_males, 
                            join_by('tag_ID')) %>%
  rename(capture_date=date)

# Filter to when tag is on male
male_locations <- male_locations %>%
  filter(datetime_local>released_dt)
```

For each male GPS location, I have used the geosphere package (distGeo default) to calculate the distance from the approximate "centre" of our study plot (71.319, -156.656). 

```{r Add distance from centre of study plot}
library(geosphere)
male_locations <- male_locations %>%
  mutate(m_from_study_centre = distm(cbind(lon, lat),
                                       cbind(-156.656, 71.319)))

male_locations <- male_locations %>%
  mutate(km_from_study_centre = as.numeric(m_from_study_centre/1000)) %>%
  select(!m_from_study_centre)
```

```{r Format male locations for mapping}
male_locations_sf <- st_as_sf(male_locations, coords=c("lon","lat"), crs=CRSdefault)
```

## Nest locations and reproductive success

```{r Import paternity results and match IDs}
parentage <- read.csv("../data/PESA2022_ParentageAnalysis.csv", na.strings=c("","NA"))

parentage <- left_join(parentage, captures[,c("bird_ID","colour_combo")], 
                       by=join_by("ID.father"=="bird_ID")) %>%
  rename(cc.father=colour_combo) %>%
  left_join(., captures[,c("bird_ID","colour_combo")], by=join_by("ID.mother"=="bird_ID")) %>%
  rename(cc.mother=colour_combo)
```

```{r Summarise paternity results}
father_summary <- parentage %>%
  group_by(ID.father, cc.father, Nest) %>%
  summarise(n_eggs=n()) %>%
  group_by(ID.father, cc.father) %>%
  summarise(n_eggs=sum(n_eggs),
            n_nests=n())

father_summary %>% flextable()
```

```{r Add location data to nests}
nest_locations <- left_join(nest_checks, gps_points, by=c("gps_id","gps_point"))
nests <- left_join(nests, 
                   nest_locations %>% filter(nest_state=="F"),
                   by='nest') %>%
  select(nest:last_fertile_day, lat:ele)
```

```{r Add female ID to nests}
nesting_females_nc <- nest_checks %>% 
  filter(!is.na(female_cc)) %>%
  group_by(nest, female_cc) %>%
  select(nest, female_cc) %>%
  unique()

nesting_females_c <- captures %>%
  filter(!is.na(colour_combo) & !is.na(nest)) %>%
  group_by(nest, colour_combo) %>%
  select(nest, colour_combo) %>%
  unique()

nesting_females <- full_join(nesting_females_nc, nesting_females_c, 
                             join_by('female_cc'=='colour_combo')) %>%
  unique() %>%
  mutate(nest = case_when(is.na(nest.x) ~ nest.y,
                          is.na(nest.y) ~ nest.x,
                          nest.x==nest.y ~ nest.x,
                          TRUE ~ "error")) %>%
  select(nest, female_cc)

nests <- left_join(nests, nesting_females, by='nest')
rm(nesting_females_nc, nesting_females_c)
```

```{r Check whether any females renested}
length(unique(nesting_females$female_cc))<nrow(nesting_females)
```

```{r Add genetic parentage to nests}
nest_parentage <- full_join(nests, parentage, join_by('nest'=="Nest")) %>%
  group_by(nest) %>%
  summarise(mothers_seen=paste(female_cc, collapse=" | "),
            mothers_genetic=paste(cc.mother, collapse=" | "),
            fathers=paste(cc.father, collapse=" | "),
            mother=first(cc.mother)) %>%
  mutate(across(everything(), ~ str_replace_all(string = .x, 
                                           pattern = "NA",
                                           replacement = "unk")),
         fathers=case_when(fathers=="unk | unk | unk | unk" ~ "unk", # improves readability
                           fathers=="unk | unk | unk" ~ "unk",
                           fathers=="unk | unk " ~ "unk",
                           TRUE ~ fathers))

nests <- left_join(nests, nest_parentage[,c('nest','mother','fathers')],
                            join_by('nest'))
```

None of the females re-nested (as far as we saw). We had one case where two females were linked to the same nest (O,Y,W identified as mother when nest found with rope, PU,O,W identified as genetic mother and later seen with the 5 chicks returned to the nest). Seems likely that original sighting of O,Y,W was a mistake - either she had another nest nearby, or she happened to be in the area when the nest was found, or the colour bands were read incorrectly.

```{r Label nests with percentage of paternity known}
nests <- nests %>%
  mutate(perc_paternity_known =  
           case_when(fathers=="unk" ~ 0,
                     fathers!="unk" ~ 100-str_count(fathers, "unk")/
                                         (str_count(fathers," ")/2+1)*100)) %>%
  mutate(perc_paternity_known = as.factor(perc_paternity_known))
```

```{r Format nests for mapping}
nests <- st_as_sf(nests, coords=c("lon","lat"), crs=CRSdefault) 
```

## Study effort

GPS tracks mark everywhere that everyone went during the study. Using these, we can confirm where our study effort was concentrated.

```{r Get GPS tracks from researchers}
con <- dbcon(
  user=user_name, 
  db = db_name)

tracks <- dbq(con,
                "SELECT * FROM GPS_TRACKS") %>%
  mutate(datetime_local=local_dt_to_posix(as.character(datetime_)))

closeCon(con)

tracks <- st_as_sf(tracks, coords=c("lon","lat"), crs=CRSdefault) 
```

# Map male captures in relation to study effort

We should exclude any males from the study that were captured on the boundary of our study site, where we weren't searching for nests and where they are more likely to be out of range of our base stations.

```{r Get male capture locations and overall capture area}
male_capture_locations <- left_join(captures, gps_points, by=c('gps_id', 'gps_point')) %>%
  filter(sex=="m" & !is.na(gps_point)) %>%
  st_as_sf(., coords=c("lon","lat"), crs=CRSdefault)
```

```{r}
maparea <- male_capture_locations %>%
    st_transform(32604) |>
    st_buffer(500) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)

box <- st_bbox(maparea %>% st_transform(map_crs))

track_map <- basemap +
  geom_sf(data = tracks %>% st_transform(crs=map_crs),
          shape=1,
          size=0.2,
          colour="hotpink",
          fill="hotpink") +
  # geom_sf(data = male_capture_locations %>% st_transform(crs=map_crs),
  #         shape=3,
  #         colour=male_colour)+
  geom_sf_text(data = male_capture_locations %>% st_transform(crs=map_crs), 
               aes(label = LL),
               size=2.5)+
  geom_sf(data = nests %>% st_transform(crs=map_crs),
            shape=21,
            colour="black")+
  coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)]) 
  
track_map
```

The (pretty ugly) map above shows everywhere that we ever went in pink, nest locations as circles, and male capture sites as colour combinations. There are two males in the lower left of the map that are towards the boundary of our study effort. All the others were caught well within the bounds of our research (including nest searching) efforts.

These two "boundary" males are R,Y,R and Y,PI,DB. These males were never resighted after capture. We can also double-check their GPS tracks to see whether their territories were within range of our research effort.

```{r}
boundary_male_locations <- male_locations_sf %>%
  filter(colour_combo=="R,Y,R" | colour_combo=="Y,PI,DB")

maparea <- male_capture_locations %>%
    st_transform(32604) |>
    st_buffer(500) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)

box <- st_bbox(maparea %>% st_transform(map_crs))

boundary_male_map <- basemap +
    geom_sf(data = tracks %>% st_transform(crs=map_crs),
          shape=1,
          size=0.2,
          colour="hotpink",
          fill="hotpink") +
  geom_sf(data = boundary_male_locations %>% st_transform(crs=map_crs),
          shape=21,
          size=1,
          aes(colour=colour_combo, fill=colour_combo)) +
  # geom_sf(data = male_capture_locations %>% st_transform(crs=map_crs),
  #         shape=3,
  #         colour=male_colour)+
  geom_sf_text(data = male_capture_locations %>% st_transform(crs=map_crs), 
               aes(label = LL),
               size=2.5)+
  geom_sf(data = nests %>% st_transform(crs=map_crs),
            shape=21,
            colour="black")+
  coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)]) 
  
boundary_male_map
```

The GPS locations of those two "boundary" males are shown above in orange and blue.

Looking at this map, I don't think there's any clear justification for excluding either of these males. They generally spent time in places where we searched for nests. So I will keep them.

# Male locations outside the study area

The study site is approximately 2km^2. Below, I'm counting any locations more than 3km from the centre of the site (i.e. approximately 2km away from the site) as outside the study area.  

```{r Set limit for being considered on site}
site_distance_limit = 3 #km
```

```{r Summarise times when males are off site}
male_locations <- male_locations %>%
  arrange(colour_combo, datetime_local) %>%
  mutate(on_site = case_when(km_from_study_centre> site_distance_limit ~ "off",
                             TRUE ~ "on"),
         site_change = case_when(lag(on_site)!=on_site ~ 1,
                                 TRUE ~ 0))

male_locations$location_chunk = cumsum(male_locations$site_change)
# Note: this isn't taking into account different birds, so we need to take that into account below

# Summarise trips away from site
male_location_summary <- male_locations %>%
  group_by(colour_combo, bird_ID, tag_ID, location_chunk, on_site) %>%
  summarise(start_dt_local=min(datetime_local),
            end_dt_local=max(datetime_local),
            duration_hrs=as.numeric(difftime(end_dt_local, 
                                             start_dt_local, 
                                             units="hours")),
            min_km_from_study_centre=min(km_from_study_centre),
            max_km_from_study_centre=max(km_from_study_centre),
            min_elevation=min(ele),
            max_elevation=max(ele),
            n_samples=n()) %>%
  filter(n_samples>1) # a single sample at or away from the site could just be an error; ignore

male_trips_offsite <- male_location_summary %>% 
  filter(on_site=="off" & duration_hrs>24)
```

```{r Summarise time spent on site each day}
male_locations <- male_locations %>%
  arrange(colour_combo, datetime_local) %>%
  mutate(date=floor_date(datetime_local, unit="day"),
         site_or_date_change = case_when(lag(on_site)!=on_site ~ 1,
                                         lag(date)!=date ~ 1,
                                 TRUE ~ 0))

male_locations$location_date_chunk = cumsum(male_locations$site_or_date_change)

# Summarise time spent on site by date
male_location_by_date <- male_locations %>%
  group_by(colour_combo, bird_ID, tag_ID, date, location_date_chunk, on_site) %>%
  summarise(start_dt_local=min(datetime_local),
            end_dt_local=max(datetime_local),
            duration_hrs=as.numeric(difftime(end_dt_local, 
                                             start_dt_local, 
                                             units="hours")),
            min_km_from_study_centre=min(km_from_study_centre),
            max_km_from_study_centre=max(km_from_study_centre),
            min_elevation=min(ele),
            max_elevation=max(ele),
            n_samples=n()) %>%
  mutate(duration_hrs=case_when(duration_hrs==0 ~ 1/(24*60)*2,
                                TRUE ~ duration_hrs)) 
         # minimum sampling interval is 2 minutes

male_location_date_summary <- male_location_by_date %>%
  group_by(colour_combo, bird_ID, tag_ID, date) %>%
  summarise(hrs_on_site=sum(duration_hrs[on_site=="on"]),
            hrs_off_site=sum(duration_hrs[on_site=="off"]),
            hrs_unknown=24-hrs_on_site-hrs_off_site,
            max_km_from_study_centre=max(max_km_from_study_centre),
            n_samples=sum(n_samples))
```

```{r Save tables}
write.csv(male_location_date_summary, 
          file=paste0(path_outputs,"male-time-on-site_by-date.csv"))
write.csv(male_trips_offsite, 
          file=paste0(path_outputs,"male-trips-offsite.csv"))
```

Below, I map the locations of males when they went more than `r `site_distance_limit`km away from the centre of study plot, if there's more than one GPS point away from the site).

```{r Get points when males are outside the study area}
male_gps_off_plot = male_locations %>%
  filter(km_from_study_centre>site_distance_limit)

males_off_plot <- male_gps_off_plot %>%
  group_by(colour_combo) %>%
  summarise(n_points_outside_site=n()) %>%
  arrange(desc(n_points_outside_site)) %>%
  filter(n_points_outside_site>1)

males_off_plot %>% flextable()

male_gps_off_plot_sf = st_as_sf(male_gps_off_plot, coords=c("lon","lat"), crs=CRSdefault)
```

My maps below aren't the prettiest, but they are useful for looking at the pattern of male movements. The only background that is shown is the study site - when that isn't visible, then the study site is outside the range of the mapped area. 

```{r Create function to map trips off plot}
plot_male_gps <- function(data, colour_id, buffer_m) {
  male_gps = data %>% 
    filter(colour_combo==colour_id) %>%
    mutate(date=format(datetime_local, "%d %B"))
  
  start = format(min(male_gps$datetime_local), "%d %B")
  end = format(max(male_gps$datetime_local), "%d %B")
  n_points = nrow(male_gps)
  n_hours = round(
    as.numeric(
      difftime(max(male_gps$datetime_local),
               min(male_gps$datetime_local),
               units="hours")), 1)
  max_distance = round(max(male_gps$km_from_study_centre), digits=0)
  
  maparea <- male_gps %>%
    st_transform(32604) |>
    st_buffer(buffer_m) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)
  
  box <- st_bbox(maparea %>% st_transform(map_crs))

  plot <- basemap +
    geom_sf(data = male_gps %>% st_transform(crs=map_crs),
            shape=21,
            size=1,
            fill="cyan3")+
  coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)])+
  theme(legend.position="left",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1),
        plot.title = element_text(colour="black")) +
  annotation_scale() +
  labs(title=colour_id,
       subtitle=paste0(max_distance, "km (max) from study site, ",
                       start,"-",end, " (", n_hours, " hours, n=", n_points,")"))
  
  print(plot)
}
```

```{r Map all trips off plot, messages=FALSE, warnings=FALSE}
for(i in 1:nrow(males_off_plot)) {
  plot_male_gps(data=male_gps_off_plot_sf,
                colour_id=males_off_plot$colour_combo[i],
                buffer_m=1000)
}

# note that number next to bar gives total length of bar
```

In addition to the trips away that we have already included in our definition of "away", there is also one male who travelled 150 km from the site (out over the ocean) and back in a single day. It doesn't really make sense to count him as being at the site on that day.

# Map male and nest locations

```{r Map nests colour-coded by paternity known}
col_vector <- c("white","lightblue","steelblue","royalblue3","navy")

nestarea <- nests %>%
    st_transform(32604) |>
    st_buffer(100) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)

box <- st_bbox(nestarea %>% st_transform(map_crs))

nest_paternity_map <- basemap +
    geom_sf(data = nests %>% st_transform(crs=map_crs),
            shape=21,
            colour="black",
            aes(fill=perc_paternity_known))+
  scale_fill_manual(values=col_vector, name="% paternity known") +
  coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)])+
  theme(legend.position="left")

nest_paternity_map
```

```{r Add male capture information}
male_capture_locations <- left_join(captures, gps_points, by=c('gps_id', 'gps_point')) %>%
  filter(sex=="m" & !is.na(gps_point)) %>%
  st_as_sf(., coords=c("lon","lat"), crs=CRSdefault)

captarea <- male_capture_locations %>%
    st_transform(32604) |>
    st_buffer(300) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)

box <- st_bbox(captarea %>% st_transform(map_crs))

nest_paternity_map +     
  geom_sf(data = male_capture_locations %>% st_transform(crs=map_crs),
          shape=3,
          colour=male_colour)+
    coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)])
```

In the plot above, sites where males were captured are marked with green +. Nest locations are marked with circles, colour-coded by the percentage of paternity that is known (0-4 eggs). There were some nests (approximately 15) that were outside the area where we were capturing males. The total percentage of nests with some paternity known was then maybe more like 37% (16/48). 8 nests from the middle of the plot were also predated before we could collect samples.

```{r Create plot function}
map_nest_males <- function(nest_data, male_data, basemap, map_crs, radius, num_males){
  nest <- nest_data$nest
  fathers <- nest_data$fathers
  nestarea <- nest_data %>%
    st_transform(32604) |>
    st_buffer(radius) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)
  
  nest_data <- nest_data %>% st_transform(map_crs)
  
  male_data <- male_data %>% 
    st_intersection(nestarea) %>%
    st_transform(map_crs)
  
  if (!is.na(num_males)) {
    male_point_count <- male_data %>%
    group_by(colour_combo) %>%
    summarise(n=n()) %>%
    arrange(desc(n))
    
    main_local_males <- head(male_point_count, num_males)
    male_data <- male_data %>%
      filter(colour_combo %in% main_local_males$colour_combo)
    
    legend_name = paste0("Male ID (top ", num_males, ")")
  }
  else {
    legend_name = "Male ID"
  }
  
  if(is.na(num_males)) {
    num_males <- length(unique(male_data$LL))
  }

  box <- st_bbox(nestarea %>% st_transform(map_crs))
  
  if(num_males>10){
   col_vector <- distinctColorPalette(num_males) # generate random colour palette
  }
  else {
    col_vector <- pal_jco()(10)
  }
  
  plot <- basemap +
    geom_sf(data=male_data, aes(colour=colour_combo), alpha=0.6)+
    geom_sf(data=nest_data, shape=23, colour="black", fill="yellow", size=3) +
    coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)] ) +
    scale_color_manual(values=col_vector, name = legend_name)  +
    annotate(geom="text", label=paste("Nest", nest, "(yellow diamond)"), 
             x = Inf, y = Inf, hjust = 1, vjust = 2, size=3)+
    annotate(geom = 'text', label=paste0("Radius from nest = ", radius, "m"),
             x = Inf, y = -Inf, hjust = 1, vjust = -3, size=3)+
    annotate(geom="text", label=paste0("Fathers = ", fathers), 
             x = Inf, y = -Inf, hjust = 1, vjust = -1, size=3)+
    theme(legend.title = element_text(size = 8),
          legend.text = element_text(size = 7),
          legend.position="left")+
    ggtitle("")
  
  return(plot)
}
```

The plot below shows the "top" males around a nest site during the fertile period. "Top" males are defined here as the males with the most GPS points in the area. I have generated a plot like this for each nest for its fertile period. 

```{r Test nest and male plot function}
nest_data <- nests %>% filter(nest=="P401")
male_data <- male_locations_sf %>%
  filter(datetime_local>=nest_data$first_fertile_day &
           datetime_local<=nest_data$last_fertile_day)

map_nest_males(nest_data, male_data, basemap, map_crs, 300, 5)
```

## Plot male locations around nests with known paternity

### Male locations during the fertile period

```{r Generate plots for nests with known paternity, warning=FALSE, echo=FALSE}
plot_radius <- 200
plot_num_males <- 5
nests_to_plot = nests %>%
  filter(fathers!="unk")

if(plot_nests==TRUE) {
nest_plots_f = list()

  for(i in 1:nrow(nests_to_plot)) {
    print(paste("i =", i))
    nest_data <- nests_to_plot[i,]
    
    # Use estimated fertile dates for nest if available; otherwise use entire fertile period
    if(!is.na(nest_data$first_fertile_day)) {
      male_data <- male_locations_sf %>%
        filter(datetime_local>=nest_data$first_fertile_day &
                 datetime_local<=nest_data$last_fertile_day) 
    }
      
    if(is.na(nest_data$first_fertile_day)) {
      male_data <- male_locations_sf %>%
        filter(datetime_local>=start_FertilePeriod &
                 datetime_local<=end_FertilePeriod) 
    }
      
    nest_plots_f[[i]] = map_nest_males(nest_data, male_data, basemap, map_crs, 
                                       plot_radius, plot_num_males)
  }

pdf(file = paste0(path_outputs,"male-nest-locations_fertile-period_", plot_num_males, "-males-per-plot.pdf"),
    title="Locations of males around nests during the fertile period")
nest_plots_f[1:nrow(nests)]
dev.off()
}

print(nest_plots_f)
```

For all but four nests, all known fathers were frequently within 200m of the nest site during the fertile period (i.e. in the top 5 males who were located most frequently within 200m of the nest site).



### Male locations during the post-fertile period

For two of the other nests, the males weren't frequently located near the nest during the fertile period, but were there in the post-fertile period. 

```{r Generate post-fertile plots for other nests, warning=FALSE, echo=FALSE}
focal_nests = c("P1103","P214","P701","P702")
plot_radius <- 200
plot_num_males <- 5
nests_to_plot = nests %>%
  filter(nest %in% focal_nests)

if(plot_nests==TRUE) {
nest_plots_pf = list()

  for(i in 1:nrow(nests_to_plot)) {
    print(paste("i =", i))
    nest_data <- nests_to_plot[i,]
    
    # Use estimated fertile dates for nest if available; otherwise use entire fertile period
    if(!is.na(nest_data$first_fertile_day)) {
      male_data <- male_locations_sf %>%
      filter(datetime_local>=nest_data$last_fertile_day) 
    }
      
    if(is.na(nest_data$first_fertile_day)) {
      male_data <- male_locations_sf %>%
      filter(datetime_local>=end_FertilePeriod) 
    }
      
    nest_plots_pf[[i]] = map_nest_males(nest_data, male_data, basemap, map_crs, 
                                       plot_radius, plot_num_males)
  }

pdf(file = paste0(path_outputs,"male-nest-locations_postfertile-period_", plot_num_males, "-males-per-plot.pdf"),
    title="Locations of males around nests after the fertile period")
nest_plots_pf[1:nrow(nests)]
dev.off()
}

print(nest_plots_pf)
```

### Locations of fathers who didn't seem to have territories near the nest

```{r Import resightings and add location data}
con <- dbcon(
  user=user_name, 
  db = db_name)

resightings <- dbq(con, "SELECT * FROM RESIGHTINGS")
closeCon(con)

resightings <- left_join(resightings, gps_points, by=c('gps_id','gps_point_start'='gps_point'))
```

```{r Explore plot for P1103}
nest_data <- nests %>% filter(nest=="P1103")

male_data <- male_locations_sf %>%
  filter(datetime_local>=nest_data$first_fertile_day &
           datetime_local<=nest_data$last_fertile_day+9*60*60*24) %>%
  # filter(datetime_local> nest_data$last_fertile_day) %>% # postfertile
  # filter(datetime_local< nest_data$first_fertile_day) %>% # prefertile
  filter(colour_combo=="DG,R,R") # |LL=="R,DG,R"|LL=="Y,Y,DG")

plot_P1103 <- map_nest_males(nest_data, male_data, basemap, map_crs, 1000, NA)
plot_P1103
```

For this nest (P1103), the female was only captured on the nest, so we don't know where she was hanging out before then. But the male was sometimes near the nest site during the fertile period, although he didn't seem to hold a territory there. 

```{r Explore plot for P701}
nest_data <- nests %>% filter(nest=="P701")

male_data <- male_locations_sf %>%
  filter(datetime_local>=nest_data$first_fertile_day &
           datetime_local<=nest_data$last_fertile_day+9*60*60*24) %>%
  filter(colour_combo=="R,DG,PI"|colour_combo=="PI,PI,R"|colour_combo=="Y,DB,Y")
  # filter(datetime_local> nest_data$last_fertile_day) %>% # postfertile
  # filter(datetime_local< nest_data$first_fertile_day) %>% # prefertile

plot_P701 <- map_nest_males(nest_data, male_data, basemap, map_crs, 1000, NA)

plot_P701
```

For the other nest (P701), it looks like the female started out around the territories of the two fathers (where she was originally caught) and then set up her nest further away on a different male's territory (see below).

```{r Plot female locations for P701}
female_sightings <- resightings %>% 
  filter(LL=="W,DB,W") %>%
  filter(datetime_>=nest_data$first_fertile_day &
           datetime_<=nest_data$last_fertile_day+9*60*60*24)%>%
    st_as_sf(., coords=c("lon","lat"), crs=CRSdefault) %>%
    st_transform(map_crs)

nestarea <- nest_data %>%
    st_transform(32604) |>
    st_buffer(1000) |> # buffer in metres
    st_union() |>
    st_transform(crs = 4326)

box <- st_bbox(nestarea %>% st_transform(map_crs))
    
plot_P701 +
  geom_sf(data=female_sightings, shape=24, fill="white", colour=female_colour, alpha=1) +
  annotate(geom="text", label=paste("Mother W,DB,W (white triangle)"), 
             x = Inf, y = Inf, hjust = 1, vjust = 4, size=3)+
    coord_sf(xlim = box[c(1,3)], ylim = box[c(2,4)])
```

## Map predated nests and determine most likely fathers 

```{r}
plot_radius <- 200
plot_num_males <- 5
nests_to_plot = nests %>%
  filter(is.na(est_hatch_date))

likely_fathers = list()

if(plot_nests==TRUE) {
nest_plots_pred = list()

  for(i in 1:nrow(nests_to_plot)) {
    print(paste("i =", i))
    nest_data <- nests_to_plot[i,]
    
    # Use estimated fertile dates for nest if available; otherwise use entire fertile period
    if(!is.na(nest_data$first_fertile_day)) {
      male_data <- male_locations_sf %>%
        filter(datetime_local>=nest_data$first_fertile_day &
                 datetime_local<=nest_data$last_fertile_day) 
    }
      
    if(is.na(nest_data$first_fertile_day)) {
      male_data <- male_locations_sf %>%
        filter(datetime_local>=start_FertilePeriod &
                 datetime_local<=end_FertilePeriod) 
    }
      
    nest_plots_pred[[i]] = map_nest_males(nest_data, male_data, basemap, map_crs, 
                                       plot_radius, plot_num_males)
  }

pdf(file = paste0(path_outputs,"male-nest-locations_predated-nests_", plot_num_males, "-males-per-plot.pdf"),
    title="Locations of males around nests during the fertile period")
nest_plots_pred[1:nrow(nests_to_plot)]
dev.off()
}

print(nest_plots_pred)
```

Likely fathers: number of nests

* DB,DB,Y: 1
* DB,DG,Y: 1
* DB,PI,PI: 2
* DB,R,O: 4
* DG,DG,DB: 1
* DG,DG,R: 1
* DG,O,DG: 1
* DG,R,DG: 1
* O,DB,O: 2
* O,R,O: 1
* O,Y,O: 2
* PI,DG,DG: 4
* PI,PI,DB: 2
* PI,R,DB: 2
* PI,Y,R: 3
* R,DG,R: 3
* Y,DG,DG: 1
* Y,Y,DG: 7
* Y,Y,Y: 1

These were manually written to a .csv file.
